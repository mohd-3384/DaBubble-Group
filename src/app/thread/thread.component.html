<!-- HEADER -->
<section class="thread-header">
  <div class="header-pill">
    <h2 class="title">{{ header.title }}</h2>
    <span class="thread-channel" *ngIf="header.channel">{{ header.channel }}</span>
  </div>

  <span class="icon-span close-btn" role="button" tabindex="0" aria-label="Thread schließen"
    (click)="close.emit()"></span>
</section>

<!-- BODY -->
<section class="thread-body">
  <div class="messages-scroll">
    <!-- ROOT -->
    <div class="message-row root" *ngIf="rootMessage as rm" [class.own]="isOwnMessage(rm)"
      [class.is-editing]="editingMessageId === rm.id" [class.is-active]="isRowActive(rm.id)"
      (mouseenter)="onRowEnter(rm.id)" (mouseleave)="onRowLeave(rm.id)">
      <img class="avatar" [src]="rm.author.avatarUrl || '/public/images/avatars/avatar-default.svg'"
        [alt]="rm.author.name" />

      <div class="message-col">
        <div class="header">
          <span class="name">{{ userName(rm.author.id) }}</span>
          <span class="dot"></span>
          <span class="time" *ngIf="rm.createdAt as d">{{ d | date:'HH:mm' }} Uhr</span>
        </div>

        <!-- Actions -->
        <div class="message-actions" *ngIf="editingMessageId !== rm.id" (click)="$event.stopPropagation()">
          <button type="button" class="msg-act-btn msg-act-add" aria-label="Add reaction"
            (click)="toggleMessageEmojiPicker($event, rm.id)"></button>

          <button *ngIf="isOwnMessage(rm)" type="button" class="msg-act-btn msg-act-more"
            aria-label="Nachricht Optionen" (click)="toggleEditMenu($event, rm)"></button>
        </div>

        <!-- More popover -->
        <div class="msg-more-popover" *ngIf="editMenuForId === rm.id && editingMessageId !== rm.id"
          (pointerenter)="onPopoverEnter(rm.id)" (pointerleave)="onPopoverLeave(rm.id)"
          (click)="$event.stopPropagation()">
          <button type="button" class="msg-more-item" (click)="startEdit(rm)">
            Nachricht bearbeiten
          </button>
        </div>

        <!-- Bubble / Edit -->
        <ng-container *ngIf="editingMessageId !== rm.id; else editRootTpl">
          <div class="bubble bubble-light" [class.bubble-own]="isOwnMessage(rm)">
            {{ rm.text }}
          </div>
        </ng-container>

        <ng-template #editRootTpl>
          <div class="edit-box" (click)="$event.stopPropagation()">
            <textarea class="edit-input" rows="3" [(ngModel)]="editDraft"></textarea>

            <div class="edit-actions">
              <div class="edit-actions-left">
                <!-- ✅ klickbar + öffnet Edit-Emoji-Picker -->
                <span class="icon-span emoji-icon" role="button" tabindex="0" aria-label="Emoji auswählen"
                  (click)="toggleEditEmojiPicker($event, rm.id)"></span>

                <!-- ✅ Edit Emoji Popover -->
                <div class="edit-emoji-popover" *ngIf="editEmojiForId === rm.id"
                  [ngStyle]="{ top: editEmojiPopoverPos.top + 'px', left: editEmojiPopoverPos.left + 'px' }"
                  [class.edit-emoji-popover--top]="editEmojiPopoverPos.placement === 'top'"
                  [class.edit-emoji-popover--bottom]="editEmojiPopoverPos.placement === 'bottom'"
                  (click)="$event.stopPropagation()">
                  <emoji-mart [showPreview]="false" [emojiTooltip]="true" [isNative]="true"
                    (emojiSelect)="onEditEmojiSelect($event)"></emoji-mart>
                </div>
              </div>

              <div class="edit-actions-right">
                <button type="button" class="btn-cancel" (click)="cancelEdit(rm)">Abbrechen</button>
                <button type="button" class="btn-save" (click)="saveEdit(rm)">Speichern</button>
              </div>
            </div>
          </div>
        </ng-template>

        <!-- Emoji popover -->
        <div class="msg-emoji-popover" *ngIf="messageEmojiForId === rm.id"
          [ngStyle]="{ top: emojiPopoverPos.top + 'px', left: emojiPopoverPos.left + 'px' }"
          [class.msg-emoji-popover--top]="emojiPopoverPos.placement === 'top'"
          [class.msg-emoji-popover--bottom]="emojiPopoverPos.placement === 'bottom'"
          (mouseenter)="onPopoverEnter(rm.id)" (mouseleave)="onPopoverLeave(rm.id)" (click)="$event.stopPropagation()">
          <emoji-mart [showPreview]="false" [emojiTooltip]="true" [isNative]="true"
            (emojiSelect)="onEmojiSelect($event)"></emoji-mart>
        </div>

        <!-- ✅ ROOT reactions (kommt jetzt live aus Root-Listener) -->
        <div class="reactions-row" *ngIf="reactionsFor(rm).length">
          <div class="reaction-wrap" *ngFor="let rct of reactionsFor(rm); trackBy: trackReaction"
            (mouseenter)="onReactionHover(rm, rct.emoji)" (mouseleave)="onReactionHover(null)">

            <button class="reaction" type="button" (click)="toggleReaction(rm, rct.emoji, 'root')"
              [class.active]="rct.reactedByMe">
              <span class="emoji">{{ rct.emoji }}</span>
              <span class="count" *ngIf="rct.count > 1">{{ rct.count }}</span>
            </button>

            <div class="reaction-tooltip" *ngIf="isReactionHovered(rm, rct.emoji)">
              <div class="rt-emoji">{{ rct.emoji }}</div>

              <div class="rt-names">
                <div class="rt-name" *ngFor="let n of reactionNames(rm, rct.emoji)">{{ n }}</div>
              </div>

              <div class="rt-text">{{ reactionVerb(rm, rct.emoji) }}</div>
            </div>
          </div>

          <button class="reaction reaction-add" type="button" aria-label="Add reaction"
            (click)="toggleMessageEmojiPicker($event, rm.id)"></button>
        </div>

        <div class="thread-teaser">
          <span class="replies-count">{{ replies.length }} Antworten</span>
          <span class="teaser-line" aria-hidden="true"></span>
        </div>
      </div>
    </div>

    <!-- REPLIES -->
    <ng-container *ngIf="replies.length > 0; else noReplies">
      <div class="message-row" *ngFor="let r of replies; trackBy: trackReply" [class.own]="isOwnMessage(r)"
        [class.is-editing]="editingMessageId === r.id" [class.is-active]="isRowActive(r.id)"
        (mouseenter)="onRowEnter(r.id)" (mouseleave)="onRowLeave(r.id)">
        <img class="avatar" [src]="r.author.avatarUrl || '/public/images/avatars/avatar-default.svg'"
          [alt]="r.author.name" />

        <div class="message-col">
          <div class="header">
            <span class="name">{{ userName(r.author.id) }}</span>
            <span class="dot"></span>
            <span class="time" *ngIf="r.createdAt as d">{{ d | date:'HH:mm' }} Uhr</span>
          </div>

          <!-- Actions -->
          <div class="message-actions" *ngIf="editingMessageId !== r.id" (click)="$event.stopPropagation()">
            <button type="button" class="msg-act-btn msg-act-add" aria-label="Add reaction"
              (click)="toggleMessageEmojiPicker($event, r.id)"></button>

            <button *ngIf="isOwnMessage(r)" type="button" class="msg-act-btn msg-act-more"
              aria-label="Nachricht Optionen" (click)="toggleEditMenu($event, r)"></button>
          </div>

          <!-- More popover -->
          <div class="msg-more-popover" *ngIf="editMenuForId === r.id && editingMessageId !== r.id"
            (pointerenter)="onPopoverEnter(r.id)" (pointerleave)="onPopoverLeave(r.id)"
            (click)="$event.stopPropagation()">
            <button type="button" class="msg-more-item" (click)="startEdit(r)">
              Nachricht bearbeiten
            </button>
          </div>

          <!-- Bubble / Edit -->
          <ng-container *ngIf="editingMessageId !== r.id; else editReplyTpl">
            <div class="bubble bubble-light" [class.bubble-own]="isOwnMessage(r)">
              {{ r.text }}
            </div>
          </ng-container>

          <ng-template #editReplyTpl>
            <div class="edit-box" (click)="$event.stopPropagation()">
              <textarea class="edit-input" rows="3" [(ngModel)]="editDraft"></textarea>

              <div class="edit-actions">
                <div class="edit-actions-left">
                  <span class="icon-span emoji-icon" role="button" tabindex="0" aria-label="Emoji auswählen"
                    (click)="toggleEditEmojiPicker($event, r.id)"></span>

                  <!-- ✅ Edit Emoji Popover -->
                  <div class="edit-emoji-popover" *ngIf="editEmojiForId === r.id"
                    [ngStyle]="{ top: editEmojiPopoverPos.top + 'px', left: editEmojiPopoverPos.left + 'px' }"
                    [class.edit-emoji-popover--top]="editEmojiPopoverPos.placement === 'top'"
                    [class.edit-emoji-popover--bottom]="editEmojiPopoverPos.placement === 'bottom'"
                    (click)="$event.stopPropagation()">
                    <emoji-mart [showPreview]="false" [emojiTooltip]="true" [isNative]="true"
                      (emojiSelect)="onEditEmojiSelect($event)"></emoji-mart>
                  </div>
                </div>

                <div class="edit-actions-right">
                  <button type="button" class="btn-cancel" (click)="cancelEdit(r)">Abbrechen</button>
                  <button type="button" class="btn-save" (click)="saveEdit(r)">Speichern</button>
                </div>
              </div>
            </div>
          </ng-template>

          <!-- Emoji popover -->
          <div class="msg-emoji-popover" *ngIf="messageEmojiForId === r.id"
            [ngStyle]="{ top: emojiPopoverPos.top + 'px', left: emojiPopoverPos.left + 'px' }"
            [class.msg-emoji-popover--top]="emojiPopoverPos.placement === 'top'"
            [class.msg-emoji-popover--bottom]="emojiPopoverPos.placement === 'bottom'"
            (mouseenter)="onPopoverEnter(r.id)" (mouseleave)="onPopoverLeave(r.id)" (click)="$event.stopPropagation()">
            <emoji-mart [showPreview]="false" [emojiTooltip]="true" [isNative]="true"
              (emojiSelect)="onEmojiSelect($event)"></emoji-mart>
          </div>

          <!-- ✅ REPLY reactions -->
          <div class="reactions-row" *ngIf="reactionsFor(r).length">
            <div class="reaction-wrap" *ngFor="let rct of reactionsFor(r); trackBy: trackReaction"
              (mouseenter)="onReactionHover(r, rct.emoji)" (mouseleave)="onReactionHover(null)">

              <button class="reaction" type="button" (click)="toggleReaction(r, rct.emoji, 'reply')"
                [class.active]="rct.reactedByMe">
                <span class="emoji">{{ rct.emoji }}</span>
                <span class="count" *ngIf="rct.count > 1">{{ rct.count }}</span>
              </button>

              <div class="reaction-tooltip" *ngIf="isReactionHovered(r, rct.emoji)">
                <div class="rt-emoji">{{ rct.emoji }}</div>

                <div class="rt-names">
                  <div class="rt-name" *ngFor="let n of reactionNames(r, rct.emoji)">{{ n }}</div>
                </div>

                <div class="rt-text">{{ reactionVerb(r, rct.emoji) }}</div>
              </div>
            </div>

            <button class="reaction reaction-add" type="button" aria-label="Add reaction"
              (click)="toggleMessageEmojiPicker($event, r.id)"></button>
          </div>

        </div>
      </div>
    </ng-container>

    <ng-template #noReplies>
      <div class="empty muted">Noch keine Antworten – schreib die erste!</div>
    </ng-template>
  </div>

  <!-- Composer -->
  <div class="composer composer--sticky" (mousedown)="closeMessageUiFromComposer()">
    <textarea class="composer-input" rows="3" placeholder="Antworten…" [(ngModel)]="draft"></textarea>

    <div class="composer-actions">
      <div class="actions-left">
        <span class="emoji-wrapper">
          <span class="icon-span emoji-icon" role="button" tabindex="0" aria-label="Emoji auswählen"
            (click)="toggleEmoji($event)"></span>

          <!-- Composer Emoji Popover -->
          <div *ngIf="showEmoji" class="emoji-popover" (click)="$event.stopPropagation()">
            <emoji-mart [showPreview]="false" [emojiTooltip]="true" [isNative]="true"
              (emojiSelect)="onComposerEmojiSelect($event)">
            </emoji-mart>
          </div>
        </span>

        <span class="mention-wrapper">
          <span class="icon-span at-icon" role="button" aria-label="Jemanden erwähnen"
            (click)="toggleUsers($event)"></span>

          <ng-container *ngIf="showUsers">
            <div class="mention-popover" (click)="$event.stopPropagation()">
              <div class="mention-item" *ngFor="let u of users; trackBy: trackUser" (click)="insertMention(u)">
                <img class="mention-avatar" [src]="u.avatarUrl || '/public/images/avatars/avatar-default.svg'" />
                <span class="mention-name">{{ u.name }}</span>
              </div>

              <div class="mention-item muted" *ngIf="!users.length">Keine User</div>
            </div>
          </ng-container>
        </span>
      </div>

      <span class="send-btn" role="button" aria-label="Senden" (click)="onSendClick($event)"></span>
    </div>
  </div>

  <div class="emoji-backdrop" *ngIf="showEmoji || showUsers || messageEmojiForId || editMenuForId"
    (click)="closePopovers()"></div>
</section>
