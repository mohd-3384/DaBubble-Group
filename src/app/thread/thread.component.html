<!-- HEADER -->
<section class="thread-header">
  <div class="header-pill">
    <h2 class="title">{{ header.title }}</h2>
    <span class="thread-channel" *ngIf="header.channel">{{ header.channel }}</span>
  </div>

  <span class="icon-span close-btn" role="button" tabindex="0" aria-label="Thread schließen"
    (click)="close.emit()"></span>
</section>

<!-- BODY -->
<section class="thread-body">
  <!-- SCROLLBEREICH -->
  <div class="messages-scroll">
    <!-- Root (Nachricht, auf die geantwortet wird) -->
    <div class="message-row root" *ngIf="rootMessage as rm" [class.own]="isOwnMessage(rm)"
      [class.is-editing]="editingMessageId === rm.id" [class.is-active]="isRowActive(rm.id)"
      (mouseenter)="onRowEnter(rm.id)" (mouseleave)="onRowLeave(rm.id)">
      <img class="avatar" [src]="rm.author.avatarUrl || '/public/images/avatars/avatar-default.svg'"
        [alt]="rm.author.name" />

      <!-- ✅ WICHTIG: KEIN mouseenter/mouseleave mehr auf message-col (verhindert Flackern) -->
      <div class="message-col">
        <div class="header">
          <span class="name">{{ rm.author.name }}</span>
          <span class="dot"></span>
          <span class="time" *ngIf="rm.createdAt as d">{{ d | date:'HH:mm' }} Uhr</span>
        </div>

        <!-- ✅ Message Actions (Hover / Active) -->
        <div class="message-actions" *ngIf="editingMessageId !== rm.id" (click)="$event.stopPropagation()">
          <!-- ✅ Emoji Button -->
          <button type="button" class="msg-act-btn msg-act-add" aria-label="Add reaction"
            (click)="toggleMessageEmojiPicker($event, rm.id)"></button>

          <!-- ✅ NUR OWN: Dots -->
          <button *ngIf="isOwnMessage(rm)" type="button" class="msg-act-btn msg-act-more"
            aria-label="Nachricht Optionen" (click)="toggleEditMenu($event, rm)"></button>
        </div>

        <!-- ✅ Message More Popover (Dots) -->
        <div class="msg-more-popover" *ngIf="editMenuForId === rm.id && editingMessageId !== rm.id"
          (pointerenter)="onPopoverEnter(rm.id)" (pointerleave)="onPopoverLeave(rm.id)"
          (click)="$event.stopPropagation()">
          <button type="button" class="msg-more-item" (click)="startEdit(rm)">
            Nachricht bearbeiten
          </button>
        </div>

        <!-- ✅ Normal bubble ODER Edit Mode -->
        <ng-container *ngIf="editingMessageId !== rm.id; else editRootTpl">
          <div class="bubble bubble-light" [class.bubble-own]="isOwnMessage(rm)">
            {{ rm.text }}
          </div>
        </ng-container>

        <!-- ✅ Edit Template (Root) -->
        <ng-template #editRootTpl>
          <div class="edit-box" (click)="$event.stopPropagation()">
            <textarea class="edit-input" rows="3" [(ngModel)]="editDraft"></textarea>

            <div class="edit-actions">
              <div class="edit-actions-left">
                <span class="icon-span emoji-icon" role="button" tabindex="0" aria-label="Emoji auswählen"></span>
              </div>

              <div class="edit-actions-right">
                <button type="button" class="btn-cancel" (click)="cancelEdit(rm)">Abbrechen</button>
                <button type="button" class="btn-save" (click)="saveEdit(rm)">Speichern</button>
              </div>
            </div>
          </div>
        </ng-template>

        <!-- ✅ Message Emoji Popover (Root) -->
        <div class="msg-emoji-popover" *ngIf="messageEmojiForId === rm.id"
          [ngStyle]="{ top: emojiPopoverPos.top + 'px', left: emojiPopoverPos.left + 'px' }"
          [class.msg-emoji-popover--top]="emojiPopoverPos.placement === 'top'"
          [class.msg-emoji-popover--bottom]="emojiPopoverPos.placement === 'bottom'"
          (mouseenter)="onPopoverEnter(rm.id)" (mouseleave)="onPopoverLeave(rm.id)" (click)="$event.stopPropagation()">
          <emoji-mart [showPreview]="false" [emojiTooltip]="true" [isNative]="true"
            (emojiSelect)="onEmojiSelect($event)">
          </emoji-mart>
        </div>

        <!-- Reactions row (Root) -->
        <div class="reactions-row" *ngIf="reactionList(rm.id).length">
          <button type="button" class="reaction" *ngFor="let it of reactionList(rm.id); trackBy: trackReaction"
            (click)="$event.stopPropagation()">
            <span class="emoji">{{ it.emoji }}</span>
            <span class="count">{{ it.count }}</span>
          </button>
        </div>

        <!-- Unter Root: Anzahl + Linie -->
        <div class="thread-teaser">
          <span class="replies-count">{{ replies.length }} Antworten</span>
          <span class="teaser-line" aria-hidden="true"></span>
        </div>
      </div>
    </div>

    <!-- Replies -->
    <ng-container *ngIf="replies.length > 0; else noReplies">
      <div class="message-row" *ngFor="let r of replies; trackBy: trackReply" [class.own]="isOwnMessage(r)"
        [class.is-editing]="editingMessageId === r.id" [class.is-active]="isRowActive(r.id)"
        (mouseenter)="onRowEnter(r.id)" (mouseleave)="onRowLeave(r.id)">
        <img class="avatar" [src]="r.author.avatarUrl || '/public/images/avatars/avatar-default.svg'"
          [alt]="r.author.name" />

        <!-- ✅ auch hier: KEIN hover auf message-col -->
        <div class="message-col">
          <div class="header">
            <span class="name">{{ r.author.name }}</span>
            <span class="dot"></span>
            <span class="time" *ngIf="r.createdAt as d">{{ d | date:'HH:mm' }} Uhr</span>
          </div>

          <!-- ✅ Message Actions (Hover / Active) -->
          <div class="message-actions" *ngIf="editingMessageId !== r.id" (click)="$event.stopPropagation()">
            <!-- ✅ Emoji Button -->
            <button type="button" class="msg-act-btn msg-act-add" aria-label="Add reaction"
              (click)="toggleMessageEmojiPicker($event, r.id)"></button>

            <!-- ✅ NUR OWN: Dots -->
            <button *ngIf="isOwnMessage(r)" type="button" class="msg-act-btn msg-act-more"
              aria-label="Nachricht Optionen" (click)="toggleEditMenu($event, r)"></button>
          </div>

          <!-- ✅ Message More Popover (Reply) -->
          <div class="msg-more-popover" *ngIf="editMenuForId === r.id && editingMessageId !== r.id"
            (pointerenter)="onPopoverEnter(r.id)" (pointerleave)="onPopoverLeave(r.id)"
            (click)="$event.stopPropagation()">
            <button type="button" class="msg-more-item" (click)="startEdit(r)">
              Nachricht bearbeiten
            </button>
          </div>

          <!-- ✅ Normal bubble ODER Edit Mode -->
          <ng-container *ngIf="editingMessageId !== r.id; else editReplyTpl">
            <div class="bubble bubble-light" [class.bubble-own]="isOwnMessage(r)">
              {{ r.text }}
            </div>
          </ng-container>

          <!-- ✅ Edit Template (Reply) -->
          <ng-template #editReplyTpl>
            <div class="edit-box" (click)="$event.stopPropagation()">
              <textarea class="edit-input" rows="3" [(ngModel)]="editDraft"></textarea>

              <div class="edit-actions">
                <div class="edit-actions-left">
                  <span class="icon-span emoji-icon" role="button" tabindex="0" aria-label="Emoji auswählen"></span>
                </div>

                <div class="edit-actions-right">
                  <button type="button" class="btn-cancel" (click)="cancelEdit(r)">Abbrechen</button>
                  <button type="button" class="btn-save" (click)="saveEdit(r)">Speichern</button>
                </div>
              </div>
            </div>
          </ng-template>

          <!-- ✅ Message Emoji Popover (Reply) -->
          <div class="msg-emoji-popover" *ngIf="messageEmojiForId === r.id"
            [ngStyle]="{ top: emojiPopoverPos.top + 'px', left: emojiPopoverPos.left + 'px' }"
            [class.msg-emoji-popover--top]="emojiPopoverPos.placement === 'top'"
            [class.msg-emoji-popover--bottom]="emojiPopoverPos.placement === 'bottom'"
            (mouseenter)="onPopoverEnter(r.id)" (mouseleave)="onPopoverLeave(r.id)" (click)="$event.stopPropagation()">
            <emoji-mart [showPreview]="false" [emojiTooltip]="true" [isNative]="true"
              (emojiSelect)="onEmojiSelect($event)">
            </emoji-mart>
          </div>

          <!-- Reactions row (Reply) -->
          <div class="reactions-row" *ngIf="reactionList(r.id).length">
            <button type="button" class="reaction" *ngFor="let it of reactionList(r.id); trackBy: trackReaction"
              (click)="$event.stopPropagation()">
              <span class="emoji">{{ it.emoji }}</span>
              <span class="count">{{ it.count }}</span>
            </button>
          </div>
        </div>
      </div>
    </ng-container>

    <ng-template #noReplies>
      <div class="empty muted">Noch keine Antworten – schreib die erste!</div>
    </ng-template>
  </div>

  <!-- COMPOSER wie Chat -->
  <div class="composer composer--sticky">
    <textarea class="composer-input" rows="3" placeholder="Antworten…" [(ngModel)]="draft"></textarea>

    <div class="composer-actions">
      <div class="actions-left">
        <!-- Emoji -->
        <span class="emoji-wrapper">
          <span class="icon-span emoji-icon" role="button" tabindex="0" aria-label="Emoji auswählen"
            (click)="toggleEmoji($event)"></span>

          <!-- Composer Emoji Popover -->
          <div *ngIf="showEmoji" class="emoji-popover" (click)="$event.stopPropagation()">
            <emoji-mart [showPreview]="false" [emojiTooltip]="true" [isNative]="true"
              (emojiSelect)="onEmojiSelect($event)">
            </emoji-mart>
          </div>
        </span>

        <!-- @ (alle User wählbar) -->
        <span class="mention-wrapper">
          <span class="icon-span at-icon" role="button" aria-label="Jemanden erwähnen"
            (click)="toggleUsers($event)"></span>

          <ng-container *ngIf="showUsers">
            <div class="mention-popover" (click)="$event.stopPropagation()">
              <div class="mention-item" *ngFor="let u of users; trackBy: trackUser" (click)="insertMention(u)">
                <img class="mention-avatar" [src]="u.avatarUrl || '/public/images/avatars/avatar-default.svg'" />
                <span class="mention-name">{{ u.name }}</span>
              </div>

              <div class="mention-item muted" *ngIf="!users.length">Keine User</div>
            </div>
          </ng-container>
        </span>
      </div>

      <span class="send-btn" role="button" aria-label="Senden" (click)="onSendClick($event)"></span>
    </div>
  </div>

  <!-- ✅ Backdrop: Klick außerhalb schließt alle Popovers (Emoji / Mention / Message Emoji / Dots) -->
  <div class="emoji-backdrop" *ngIf="showEmoji || showUsers || messageEmojiForId || editMenuForId"
    (click)="closePopovers()"></div>
</section>